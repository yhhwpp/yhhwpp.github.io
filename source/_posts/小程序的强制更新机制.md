---
title: 小程序的强制更新机制
date: 2018-03-30 18:13:59
tags: 小程序
categories: 微信
---

之前小程序发布新版本后，新版本覆盖率比较慢，因为小程序的更新机制是异步的，部分用户不会马上应用上新版本。

小程序启动会有两种情况，一种是「冷启动」，一种是「热启动」。 假如用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时无需重新启动，只需将后台态的小程序切换到前台，这个过程就是热启动；冷启动指的是用户首次打开或小程序被微信主动销毁后再次打开的情况，此时小程序需要重新加载启动。

小程序的异步更新发生在冷启动过程，当发现新版本后，会异步下载新版本的代码包，但不会马上应用上最新版本，需要等小程序下一次冷启动，才会应用上新版本。


<!-- more -->

## 解决方案

从基础库 1.9.90 开始，api提供了 `wx.getUpdateManager `接口，使用该接口，可以获知是否有新版本小程序、新版本是否下载好以及应用新版本的能力。

当小程序冷启动时，会自动向微信后台请求新版本信息，如果有新版本，会马上触发新版本的下载。开发者可以通过 wx.getUpdateManager，获知当前更新的状态。

`wx.getUpdateManager` 接口会返回一个 `UpdateManager` 实例，UpdateManager 包含了三个回调：

- onCheckForUpdate：当小程序向后台请求完新版本信息，会通知这个版本告知检查结果
- onUpdateReady：当新版本下载完成，会回调这个事件
- onUpdateFailed: 当新版本下载失败，会回调这个事件

还有重启应用新版本的接口：

- applyUpdate：当新版本下载完成（onUpdateReady），调用该方法会强制当前小程序应用上新版本并重启

具体示例：
```
// wx.getUpdateManager 在 1.9.90 才可用，请注意兼容
const updateManager = wx.getUpdateManager()
 
updateManager.onCheckForUpdate(function (res) {
  // 请求完新版本信息的回调
  console.log(res.hasUpdate)
})
 
updateManager.onUpdateReady(function () {
  wx.showModal({
    title: '更新提示',
    content: '新版本已经准备好，是否马上重启小程序？',
    success: function (res) {
      if (res.confirm) {
        // 新的版本已经下载好，调用 applyUpdate 应用新版本并重启
        updateManager.applyUpdate()
      }
    }
  })
})
 
updateManager.onUpdateFailed(function () {
  // 新的版本下载失败
})
```

更详细信息可以参考 [UpdateManager](https://developers.weixin.qq.com/miniprogram/dev/api/getUpdateManager.html)的详细文档

### 最佳实践
从用户体验上来说，还是建议只在非常必要时才强制用户重启更新，例如出现线上紧急 BUG。通常情况下，可以选通过 wx.showModal 弹出选择框让用户选择是否重启更新（实现请参考示例代码）。

### 如何调试
最新版本的微信开发者工具提供了强制更新的调试能力，通过`编译模式 - 编辑编译模式` - 勾上「下次编译时模拟更新」即可在开发者工具上调试强制更新功能。

---------

<center><img src="https://subscription-1255463026.cos.ap-guangzhou.myqcloud.com/subscription.png" width="180" ></center>






